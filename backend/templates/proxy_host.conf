# ----------------------------------------------------------------------
# {{ domain_names | join: ", " }}
# DO NOT EDIT THIS FILE DIRECTLY, CHANGES WILL BE LOST WHEN UPDATING!
# ----------------------------------------------------------------------
{% assign forward_host_last_char = forward_host | slice: -1 -%}

{% if enabled %}
  server {
    {% include "_common.conf" %}

    {% if access_list_id > 0 %}
      {% if access_list.items.length > 0 %}
        # Authorization
        auth_basic            "basic access authentication required";
        auth_basic_user_file  /data/access/{{ access_list_id }};
        {% if access_list.pass_auth %}
          proxy_set_header Authorization "";
        {% endif %}
      {% endif %}
      # Access Rules: {{ access_list.clients | size }} total
      {% for client in access_list.clients %}
        {{ client | nginxAccessRule }}
      {% endfor %}
      deny all;
      # Access checks must...
      {% if access_list.satisfy_any %}
        satisfy any;
      {% else %}
        satisfy all;
      {% endif %}
    {% endif %}

    {% if use_default_location %}
      location / {

        {% if forward_scheme == "http" or forward_scheme == "https" %}

          include proxy-headers.conf;
          {% if allow_websocket_upgrade == false %}proxy_set_header Accept-Encoding "";{% endif %}
          proxy_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};

        {% elsif forward_scheme == "grpc" or forward_scheme == "grpcs" %}

          include grpc-headers.conf;
          {% if allow_websocket_upgrade == false %}grpc_set_header Accept-Encoding "";{% endif %}
          grpc_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};

        {% elsif forward_scheme == "path" %}

          {% if forward_host_last_char == "/" %}
            alias {{ forward_host }};
          {% else %}
            root {{ forward_host }};
          {% endif %}

          {% if allow_websocket_upgrade == true %}fancyindex on;{% endif %}

          {% if forward_path != null %}
            location ~* \.php(?:$|/) {
              fastcgi_split_path_info ^(.*\.php)(/.*)$;
              try_files $fastcgi_script_name =404;
              fastcgi_pass unix:/run/php{{ forward_port }}.sock;
            }
          {% endif %}

        {% endif %}
      }
    {% endif %}

    # custom locations
    {{ locations }}

    {{ advanced_config }}

    # Custom
    include /data/custom_nginx/server_proxy.conf;
  }
{% endif %}
