{% assign path_first_char = path | slice: 0 -%}

{% if path != "/" and path_first_char == "/" and path_last_char == "/" %}
  location {{ path | remove_last: "/" }} {
    absolute_redirect off;
    return 301 {{ path }};
  }
{% endif %}

location {{ path }} {
  set $forward_scheme "{{ forward_scheme }}";
  set $server         "{{ forward_host }}";
  set $port           "{{ forward_port }}";
  set $forward_path   "{{ forward_path }}";
    
  {% if forward_scheme == "http" or forward_scheme == "https" %}

    include proxy-headers.conf;
    {% if allow_websocket_upgrade == false %}proxy_set_header Accept-Encoding "";{% endif %}
    proxy_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};

  {% elsif forward_scheme == "grpc" or forward_scheme == "grpcs" %}

    include grpc-headers.conf;
    {% if allow_websocket_upgrade == false %}grpc_set_header Accept-Encoding "";{% endif %}
    grpc_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};

  {% elsif forward_scheme == "path" %}

    {% if forward_host_last_char == "/" %}
      alias {{ forward_host }};
    {% else %}
      root {{ forward_host }};
    {% endif %}

    {% if allow_websocket_upgrade == true %}fancyindex on;{% endif %}

    {% if forward_path != null %}
      location ~* \.php(?:$|/) {
        fastcgi_split_path_info ^(.*\.php)(/.*)$;
        try_files $fastcgi_script_name =404;
        fastcgi_pass unix:/run/php{{ forward_port }}.sock;
      }
    {% endif %}

  {% endif %}

  {{ advanced_config }}
}
