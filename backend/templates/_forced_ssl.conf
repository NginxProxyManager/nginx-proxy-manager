{% if certificate and certificate_id > 0 -%}
{% if ssl_forced == 1 or ssl_forced == true %}
{% if access_list %}{% assign clients_size = access_list.clients | size %}{% else %}{% assign clients_size = 0 %}{% endif %}
{% if access_list_id > 0 and clients_size > 0 %}
    # Force SSL (only for allowed IPs - denied IPs will get 403 from access rules)
    set $redirect_to_ssl 0;
    if ($scheme = "http") {
        set $redirect_to_ssl 1;
    }
    if ($access_list_{{ access_list_id }}_allowed = 0) {
        set $redirect_to_ssl 0;
    }
    if ($request_uri = /.well-known/acme-challenge/test-challenge) {
        set $redirect_to_ssl 0;
    }
    if ($redirect_to_ssl = 1) {
        return 301 https://$host$request_uri;
    }
{% else %}
    # Force SSL
    include conf.d/include/force-ssl.conf;
{% endif %}
{% endif %}
{% endif %}