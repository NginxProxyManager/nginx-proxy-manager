services:
  app:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_PATH: /data/app/app.db
      SESSION_SECRET: ${SESSION_SECRET:-change-me}
      CADDY_API_URL: http://caddy:2019
      CERTS_DIRECTORY: /data/certs
    volumes:
      - ./data/app:/data/app
      - ./data/certs:/data/certs
    depends_on:
      - caddy

  caddy:
    build:
      context: .
      dockerfile: docker/caddy/Dockerfile
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    environment:
      PRIMARY_DOMAIN: ${PRIMARY_DOMAIN:-caddyproxymanager.com}
    volumes:
      - ./data/caddy:/data
      - ./data/certs:/data/certs:ro
