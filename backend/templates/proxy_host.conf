{% include "_header_comment.conf" %}

{% if enabled %}

{% include "_hsts_map.conf" %}

{% if rate_limit_enabled == 1 or rate_limit_enabled == true %}
{% assign rate_limit_period = rate_limit_period | default: "minute" %}
{% assign rate_limit_unit = "m" %}
{% if rate_limit_period == "second" %}
{% assign rate_limit_unit = "s" %}
{% endif %}
limit_req_zone $binary_remote_addr zone=proxy_host_{{ id }}:10m rate={{ rate_limit }}r/{{ rate_limit_unit }};
{% endif %}

{% if load_balancing_enabled == 1 or load_balancing_enabled == true %}
upstream proxy_host_{{ id }}_upstream {
{% if load_balancing_method == "least_conn" %}
  least_conn;
{% elsif load_balancing_method == "ip_hash" %}
  ip_hash;
{% endif %}
{% for upstream in load_balancing_servers %}
  server {{ upstream.host }}:{{ upstream.port }}{% if upstream.weight %} weight={{ upstream.weight }}{% endif %};
{% endfor %}
}
{% endif %}

server {
  set $forward_scheme {{ forward_scheme }};
  set $server         "{{ forward_host }}";
  set $port           {{ forward_port }};

{% include "_listen.conf" %}
{% include "_certificates.conf" %}
{% include "_assets.conf" %}
{% include "_exploits.conf" %}
{% include "_hsts.conf" %}
{% include "_forced_ssl.conf" %}

{% if allow_websocket_upgrade == 1 or allow_websocket_upgrade == true %}
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
proxy_http_version 1.1;
{% endif %}

  access_log /data/logs/proxy-host-{{ id }}_access.log proxy;
  error_log /data/logs/proxy-host-{{ id }}_error.log warn;

{% if rate_limit_enabled == 1 or rate_limit_enabled == true %}
{% assign burst_value = rate_limit_burst | plus: 0 %}
{% if burst_value > 0 %}
  limit_req zone=proxy_host_{{ id }} burst={{ burst_value }}{% if rate_limit_delay != 1 and rate_limit_delay != true %} nodelay{% endif %};
{% else %}
  limit_req zone=proxy_host_{{ id }};
{% endif %}
  limit_req_status 429;
{% endif %}

{{ advanced_config }}

{{ locations }}

{% if use_default_location %}

  location / {

{% include "_access.conf" %}
{% include "_hsts.conf" %}

    {% if allow_websocket_upgrade == 1 or allow_websocket_upgrade == true %}
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_http_version 1.1;
    {% endif %}

    # Proxy!
    include conf.d/include/proxy.conf;
    {% if load_balancing_enabled == 1 or load_balancing_enabled == true %}
    proxy_pass $forward_scheme://proxy_host_{{ id }}_upstream;
    {% else %}
    proxy_pass $forward_scheme://$server:$port;
    {% endif %}
  }
{% endif %}

  # Custom
  include /data/nginx/custom/server_proxy[.]conf;
}
{% endif %}
